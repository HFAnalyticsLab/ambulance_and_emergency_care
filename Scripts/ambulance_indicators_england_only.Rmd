---
title: "Ambulance indicators England Only"
output:
   html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(data.table)
library(aws.s3)
library(readr)
library(tidyverse)
library(rio)
library(lubridate)
library(ggplot2)
library(ggtext)
library(hms)
library(tidyverse)
library(THFstyle)
library(plotly)
library(tsibble)
library(knitr)
library(scales)
library(fpp2)
library(zoo)
library(forcats)

```


This document is for scoping purposes and is not intended for use outside of the Data Analaytics team.\
Data obtained from [NHS England, Ambulance Quality Indicators](https://www.england.NHS.uk/statistics/statistical-work-areas/ambulance-quality-indicators/ambulance-quality-indicators-data-2021-22/)\

# Ambulance Reponse Times 

## Response Times {.tabset}

```{r load, echo=FALSE}
buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'


amb_dta<-s3read_using(read.csv # Which function are we using to read
                   , object = 'amb_RT_clean.csv' # File to open
                   , bucket = buck) # Bucket name defined above

amb_dta_plot<-amb_dta %>% 
 pivot_longer(c(c1_mean:c4_90thcent), names_to = 'metric', values_to = 'resp_time')

amb_dta_plot<-amb_dta_plot %>% 
  mutate(resp_time2=as.POSIXct(as.numeric(resp_time),origin = "1970-01-01", tz="GMT")) %>% 
  mutate(resp_time2=format(resp_time2, format="%H:%M:%S")) %>% 
  mutate(resp_time2=as_hms(resp_time2)) %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                              "Midlands","East of England","London","South East","South West")))


m <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 0
)



```

```{r setup_regions, echo=FALSE}

org_list<-unique(amb_dta_plot$org_name)

```



```{r graphs_function, echo=FALSE}




trends_graph <-  function(data=amb_dta_plot,var.x="North East and Yorkshire"){
  aaa <- ggplot2::enquo(var.x)
  # bbb <- ggplot2::enquo(var.y)
  plot <-  data %>%
    filter(org_lab==!!aaa) %>%
      mutate(met_group=substr(metric,0,3)) %>% 
  mutate(met_cat=ifelse(str_detect(metric,'mean'),'Mean','90th centile')) %>% 
  mutate(met_cat=factor(met_cat, levels=c('Mean', '90th centile'))) %>% 
  mutate(met_lab=ifelse(str_detect(metric, 'mean'), paste(met_group,"_Mean (hours:min:sec)")
                        ,paste(met_group,"_90th centile (hours:min:sec)"))) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_group, colour=met_group))+
  geom_line(aes(linetype=met_cat))+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  # scale_y_time(breaks = as_hms(seq(0, 72000, by = 1800)))+
  theme_THF()+
  facet_grid(cols=vars(met_cat))+
  scale_colour_THF()+
    labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
    ggtitle(var.x)+
    theme(legend.text=element_text(size=11),
          legend.title = element_blank(),
          axis.text.x=element_text(size=8, angle=60), 
          axis.text.y=element_text(size=11),
          plot.caption = element_markdown(hjust=0, size=9),
          plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(-10,-10,-10,-10))

  ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)
}


```

### England

```{r}
trends_graph(var.x=org_list[1])

```


### Rolling average 

```{r, echo=FALSE}

buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'


amb_response_raw<-s3read_using(read.csv # Which function are we using to read
                      , object = 'amb_RT_regions.csv' # File to open
                      , bucket = buck) # Bucket name defined above



amb_response<-amb_response_raw %>% 
  filter(org_code=="Eng") %>% 
  pivot_longer(c(c1_mean:c4_90thcent), names_to = 'metric', values_to = 'resp_time') %>% 
  mutate(resp_time=as.numeric(resp_time)) %>% 
  mutate(date=as.Date(date, format="%Y-%m-%d")) %>% 
  mutate(date2=yearmonth(date)) %>% 
  # mutate(resp_time2=as.POSIXct(as.numeric(resp_time),origin = "1970-01-01", tz="GMT")) %>% 
  # mutate(resp_time2=format(resp_time2, format="%H:%M:%S")) %>% 
  # mutate(resp_time2=as_hms(resp_time2)) %>% 
  pivot_wider(c("org_name", "date", "date2"),names_from=  metric, values_from = resp_time)

amb_response_average<-amb_response %>% 
  mutate(c1_mean_rollmean=rollmean(c1_mean, k=12,fill=NA),
         c2_mean_rollmean=rollmean(c2_mean, k=12,fill=NA),
         c3_mean_rollmean=rollmean(c3_mean, k=12,fill=NA),
         c4_mean_rollmean=rollmean(c4_mean, k=12,fill=NA),
         c1_90thcent_rollmean=rollmean(c1_90thcent, k=12,fill=NA),
         c2_90thcent_rollmean=rollmean(c2_90thcent, k=12,fill=NA),
         c3_90thcent_rollmean=rollmean(c3_90thcent, k=12,fill=NA),
         c4_90thcent_rollmean=rollmean(c4_90thcent, k=12,fill=NA)) %>% 
  drop_na()

start_dates<-format(as.Date(seq(ymd('2017-08-01'),ymd('2021-05-01'),by='1 month')),"%Y-%m-%d")
end_dates<-format(as.Date(seq(ymd('2018-07-01'),ymd('2022-04-01'),by='1 month')),"%Y-%m-%d")

list_dates<-paste0(yearmonth(start_dates),"-",yearmonth(end_dates))
order<-c(1:46)

amb_response_average_plots<-cbind(amb_response_average,list_dates,order)

amb_response_average_plots<-amb_response_average_plots %>% 
  select(c(date, date2, list_dates, order, contains("rollmean"))) %>% 
  pivot_longer(c(c1_mean_rollmean:c4_90thcent_rollmean), names_to = 'metric', values_to = 'resp_time') %>% 
  mutate(resp_time=as.numeric(resp_time)) %>% 
  mutate(date=as.Date(date, format="%Y-%m-%d")) %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(resp_time2=as.POSIXct(as.numeric(resp_time),origin = "1970-01-01", tz="GMT")) %>%
  mutate(resp_time2=format(resp_time2, format="%H:%M:%S")) %>%
  mutate(resp_time2=as_hms(resp_time2))

plot<-amb_response_average_plots %>%
  mutate(met_group=substr(metric,0,2)) %>% 
  mutate(met_cat=ifelse(str_detect(metric,'cent'),'90th centile','Mean')) %>% 
  mutate(met_cat=factor(met_cat, levels=c('Mean', '90th centile'))) %>% 
  mutate(met_lab=ifelse(str_detect(metric, 'mean'), paste(met_group,"_Mean (hours:min:sec)")
                        ,paste(met_group,"_90th centile (hours:min:sec)"))) %>% 
  mutate(name=fct_reorder(list_dates,order)) %>% 
  ggplot(.,aes(x=name, y=resp_time2, group=met_group, colour=met_group))+
  geom_line(aes(linetype=met_cat))+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  # scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  # scale_y_time(limits = as_hms(c(0,72000)), breaks = as_hms(seq(0, 72000, by = 7200)))+
  scale_y_time(breaks = as_hms(seq(0, 72000, by = 1800)))+
  theme_THF()+
  facet_grid(cols=vars(met_cat))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))


ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```



# Incidents {.tabset}

```{r, echo=FALSE}

buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'

amb_incidents<-s3read_using(read.csv # Which function are we using to read
                      , object = 'amb_incidents.csv' # File to open
                      , bucket = buck) # Bucket name defined above

list_org_codes_region<-c("Y63", "Y62","Y60", "Y61", "Y56", "Y59", "Y58")



amb_dta_regions<-amb_incidents %>% 
  filter(org_code %in% c(list_org_codes_region, "Eng")) %>%
  select(c(year:c4, date)) %>% 
  pivot_longer(c(all_incidents:c4), names_to = 'metric', values_to = 'incidents')


amb_dta_regions<-amb_dta_regions %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                           "Midlands","East of England","London","South East","South West")))

```

## All incidents


```{r, echo=FALSE}



plot<-amb_dta_regions %>%
  filter(org_code=="Eng"& metric=="all_incidents")%>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = 'months',date_labels = "%b %g")+
  # scale_y_continuous(labels = comma) +
  theme_THF()+
  # facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```



## All incidents and category 1


```{r, echo=FALSE, warning=FALSE}


amb_incidents2<-amb_incidents %>% 
  filter(org_code=="Eng") %>% 
  select(c(year:c4,date)) %>% 
  mutate(date=as.Date(date, format="%Y-%m-%d")) %>% 
  mutate(date2=yearmonth(date)) %>% 
  select(all_incidents:date2)


prop_incidents<-amb_incidents2 %>% 
  mutate(all_incidents=as.numeric(all_incidents),
          c1_prop=as.numeric(c1)/as.numeric(all_incidents),
         c2_prop=as.numeric(c2)/as.numeric(all_incidents),
         c3_prop=as.numeric(c3)/as.numeric(all_incidents),
         c4_prop=as.numeric(c4)/as.numeric(all_incidents))

coeff=max(prop_incidents$all_incidents)
ggp1 <- ggplot(prop_incidents) +
  geom_bar(aes(date2, all_incidents), color="gray69", stat="identity", fill="gray69", alpha=.4) +
  scale_y_continuous(labels=comma)+
  xlab("") +
  theme(axis.text.x=element_text(angle=90, hjust=1))
ggp2 <- ggp1 +
  geom_line(aes(date2, c1_prop*coeff, group=1), color="red", lwd=0.5, linetype='longdash')
ggp3 <- ggp2 +
  scale_y_continuous(name="All incidents", labels=comma, sec.axis=sec_axis(~./coeff, name="Percentage of C1 incidents (%)")) +
  geom_hline(yintercept = coeff*0.1, colour = '#524c48', linetype='solid', alpha=.4)+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  ggtitle("Incidents") +
  theme_THF()
ggp3

```



## Category 

```{r, echo=FALSE}

plot<-amb_dta_regions %>%
  filter(org_code == "Eng"& metric != "all_incidents" ) %>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  # facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  ggtitle("England")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

## Rolling average (categories)

```{r, echo=FALSE}

roll_mean_incidents<-amb_incidents2 %>% 
  mutate(all_incidents_rollmean=rollmean(as.numeric(all_incidents), k=12,fill=NA),
         c1_rollmean=rollmean(as.numeric(c1), k=12,fill=NA),
         c2_rollmean=rollmean(as.numeric(c2), k=12,fill=NA),
         c3_rollmean=rollmean(as.numeric(c3), k=12,fill=NA),
         c4_rollmean=rollmean(as.numeric(c4), k=12,fill=NA)) %>% 
  drop_na()


start_dates<-format(as.Date(seq(ymd('2017-08-01'),ymd('2021-05-01'),by='1 month')),"%Y-%m-%d")
end_dates<-format(as.Date(seq(ymd('2018-07-01'),ymd('2022-04-01'),by='1 month')),"%Y-%m-%d")

list_dates<-paste0(yearmonth(start_dates),"-",yearmonth(end_dates))
order<-c(1:46)

amb_incidents_average_plots<-cbind(roll_mean_incidents,list_dates,order)

amb_incidents_average_plots<-amb_incidents_average_plots %>% 
  select(c(date, date2, list_dates, order, contains("rollmean"))) %>% 
  pivot_longer(c(c1_rollmean:c4_rollmean), names_to = 'metric', values_to = 'counts') %>% 
  mutate(met_group=substr(metric,0,2)) %>% 
  mutate(met_cat=ifelse(str_detect(metric,'cent'),'90th centile','Mean')) %>% 
  mutate(met_cat=factor(met_cat, levels=c('Mean', '90th centile'))) %>% 
  mutate(met_lab=ifelse(str_detect(metric, 'mean'), paste(met_group,"_Mean (hours:min:sec)")
                        ,paste(met_group,"_90th centile (hours:min:sec)"))) %>%
  mutate(name=fct_reorder(list_dates,order)) 


plot<-amb_incidents_average_plots %>% 
  ggplot(.,aes(x=name, y=counts, group=met_group, colour=met_group))+
  geom_line(linetype='solid')+
  scale_y_continuous(labels=comma)+
  theme_THF()+
  # facet_grid(cols=vars(met_cat))+
  scale_colour_THF()+
  labs(x = "", y="Counts of incidents", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))



ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```


## Type of incidents

```{r, echo=FALSE}

amb_dta_regions_out<-amb_incidents %>% 
  filter(org_code %in% c(list_org_codes_region, "Eng")) %>% 
  select(c(year:all_incidents,hear_treat:date)) %>% 
  pivot_longer(c(all_incidents:see_treat), names_to = 'metric', values_to = 'incidents')

amb_dta_regions_out<-amb_dta_regions_out %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(incidents=as.numeric(incidents)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                           "Midlands","East of England","London","South East","South West")))
```

```{r, echo=FALSE}
plot<-amb_dta_regions_out %>%
  filter(org_code=="Eng"& metric!="all_incidents")%>% 
   ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="fill", stat="identity")+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  # scale_y_continuous(labels = comma) +
  theme_THF()+
  # facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Incidents", caption = "NHS England, Ambulance Quality Indicators")+
  ggtitle("England")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)
```

## Types of incidents (rolling average)
```{r, echo=FALSE}

amb_incidents_type<-amb_incidents %>% 
  filter(org_code=="Eng") %>% 
  select(c(year:all_incidents,hear_treat:date)) %>% 
  mutate(date=as.Date(date, format="%Y-%m-%d")) %>% 
  mutate(date2=yearmonth(date)) %>% 
  select(all_incidents:date2)


  roll_mean_incidents_types<-amb_incidents_type %>% 
    mutate(hear_treat_rollmean=rollmean(as.numeric(hear_treat), k=12,fill=NA),
           convey_ED_rollmean=rollmean(as.numeric(convey_ED), k=12,fill=NA),
           convey_elsewhere_rollmean=rollmean(as.numeric(convey_elsewhere), k=12,fill=NA),
           see_treat_rollmean=rollmean(as.numeric(see_treat), k=12,fill=NA)) %>% 
    drop_na()
  
amb_incidents_types_average_plots<-cbind(roll_mean_incidents_types,list_dates,order)
  
amb_incidents_types_average_plots<-amb_incidents_types_average_plots %>% 
    select(c(date, date2, list_dates, order, contains("rollmean"))) %>% 
    pivot_longer(c(hear_treat_rollmean:see_treat_rollmean), names_to = 'metric', values_to = 'counts') %>% 
    mutate(name=fct_reorder(list_dates,order)) 
  
  
plot<-amb_incidents_types_average_plots %>% 
    ggplot(.,aes(x=name, y=counts, group=metric, colour=metric))+
    geom_line(linetype='solid')+
    scale_y_continuous(labels=comma)+
    theme_THF()+
    # facet_grid(cols=vars(met_cat))+
    scale_colour_THF()+
    labs(x = "", y="Incidents counts", caption = "NHS England, Ambulance Quality Indicators")+
    theme(legend.text=element_text(size=11),
          legend.title = element_blank(),
          axis.text.x=element_text(size=8, angle=90), 
          axis.text.y=element_text(size=11),
          plot.caption = element_markdown(hjust=0, size=9),
          plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(-10,-10,-10,-10))
  
ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```




# Workforce 

## FTE count {.tabset}

### England
```{r, echo=FALSE}

buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'

wf_eng<-s3read_using(read.csv # Which function are we using to read
                            , object = 'workforce_eng.csv' # File to open
                            , bucket = buck) # Bucket name defined above


wf_eng<-wf_eng %>% 
  mutate(date2=format(as.Date(date), "%Y-%m")) 


list_dates<-format(as.Date(seq(ymd('2017-08-31'),ymd('2022-02-08'),by='4 weeks')),"%Y-%m")

plot<-wf_eng %>%
  filter(group=="England" & met=="fte_count") %>% 
  filter(date2 %in% list_dates) %>% 
  ggplot(.,aes(x=date, y=val, group=group))+
  geom_point(colour='#dd0031')+
  geom_line(linetype='solid', colour='#dd0031')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  labs(x = "", y="FTE count", caption = "NHS Digital-workforce statistics")+
  ggtitle("England")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```

### Ambulance staff

```{r echo=FALSE}
plot<-wf_eng %>%
  filter(str_detect(group,"Ambulance") &met=="fte_count") %>% 
  mutate(date2=format(as.Date(date), "%Y-%m")) %>% 
  arrange(date2) %>% 
  ggplot(.,aes(x=date, y=val, group=group, colour=group))+
  geom_point()+
  geom_line(linetype='solid')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  labs(x = "", y="FTE count", caption = "NHS Digital-workforce statistics")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

### Total ambulance staf

```{r, echo=FALSE}

wf_eng_amb<-wf_eng %>% 
  mutate(date2=format(as.Date(date), "%Y-%m")) %>% 
  filter(date2 %in% list_dates) %>% 
  filter(met=="fte_count") %>% 
  filter(str_detect(group, "Ambulance")) %>% 
  group_by(date2) %>% 
  mutate(total=sum(val)) %>% 
  select(-c("group","met","val" )) %>% 
  distinct()


plot<-wf_eng_amb %>%
  arrange(date2) %>% 
  ggplot(.,aes(x=date, y=total, group=1))+
  geom_point(colour='#dd0031')+
  geom_line(linetype='solid', colour='#dd0031')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  labs(x = "", y="FTE count", caption = "NHS Digital-workforce statistics")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```



## Turnover rate

```{r, echo=FALSE}

turnover<-s3read_using(read.csv # Which function are we using to read
                       , object = 'turnover_clean.csv' # File to open
                       , bucket = buck) # Bucket name defined above
turnover<-turnover %>% 
  mutate(date2=paste0(year_end,"-",ifelse(period==12,period,paste0(0,period)),"-",ifelse(period %in% c(9,6),30,31))) %>% 
  mutate(date=as.Date(date2, origin = "1899-12-30")) %>% 
  mutate(date=lubridate::date(date))         



list_dates<-format(as.Date(seq(ymd('2017-09-30'),ymd('2021-12-31'),by='3 months')),"%Y-%b")
           
plot<-turnover %>%
  mutate(filter_date=format(as.Date(date), "%Y-%b"))%>% 
  filter(filter_date %in% list_dates) %>% 
  ggplot(., aes(x=date, y=stability_index*100, group=staff_group, colour=staff_group))+
  geom_line(linetype='solid')+
  scale_x_yearmonth( breaks = '3 months',date_labels = "%b %g")+
  theme_THF()+
  labs(x = "Year end", y="Stability Index (%)", caption = "NHS Digital-workforce statistics")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))


ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```

## Sick and absence rate 

Includes ambulance and support to ambulance staff 

```{r, echo=FALSE}


sick_ab<-s3read_using(read.csv # Which function are we using to read
                      , object = 'sick_ab_clean.csv' # File to open
                      , bucket = buck) # Bucket name defined above
           
list_dates<-format(as.Date(seq(ymd('2017-09-01'),ymd('2022-04-01'),by='months')),"%Y-%m")

plot<-sick_ab %>% 
  mutate(filter_date=format(as.Date(date2), "%Y-%m"))%>% 
  filter(filter_date %in% list_dates) %>%
  arrange(filter_date) %>% 
  ggplot(., aes(x=date2, y=sa_rate, group=org_type, colour=org_type))+
  geom_point()+
  geom_line()+
  scale_x_yearmonth( breaks = '3 months',date_labels = "%b %g")+
  theme_THF()+
  labs(x = "", y="Sickness and Absence rate (%)", caption = "NHS Digital-workforce statistics")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))


ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```


# Correlations {.tabset}

## Ambulance indicators {.tabset}

### Response Times

```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'response_times_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above

tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")



```

### Incidents

```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'incidents_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above


tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")

```

## A&E indicators {.tabset}

### Attendances 

```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'ae_attends_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above

tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")

```

### Waiting Times

```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'ae_wait_times_type_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above

tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")

```


### Admissions and waiting times till admissions 

```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'ae_wait_times_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above

tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")

```


## Bed occupancy indicators {.tabset}

### Overnight bed occupancy 
```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'bed_occupancy_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above

tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")

```

## Workforce indicators {.tabset}

### FTE headcount
```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'fte_total_count_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above

tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")

```

### Staff sickness and absence rate
```{r, echo=FALSE}

buck <- 'thf-dap-tier0-projects-iht-067208b7-resultsbucket-zzn273xwd1pg/ambulance'

tab<-s3read_using(read.csv # Which function are we using to read
                  , object = 'sa_rate_corr.csv' # File to open
                  , bucket = buck) # Bucket name defined above

tab<-tab %>% 
  mutate(cor=ifelse(p>0.05,round(cor,2), paste0(round(cor,2),"*"))) %>% 
  select(-c(X, p)) %>% 
  pivot_wider(names_from = row, values_from=cor) %>% 
  rename('variables'='column')

kable(tab, caption= "* p<0.05")

```

# Calls {.tabset}

## Counts

```{r, echo=FALSE}

# Data load -----------------------------------------------------------------


buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'


amb_dta<-s3read_using(read.csv # Which function are we using to read
                      , object = 'amb_calls.csv' # File to open
                      , bucket = buck) # Bucket name defined above

amb_dta_plot<-amb_dta %>% 
  pivot_longer(c(answered_times_mean:answered_times_90), names_to = 'metric', values_to = 'answer_time')

amb_dta_plot<-amb_dta_plot %>% 
  mutate(answer_time2=as.POSIXct(as.numeric(answer_time),origin = "1970-01-01", tz="GMT")) %>% 
  mutate(answer_time2=format(answer_time2, format="%H:%M:%S")) %>% 
  mutate(answer_time2=as_hms(answer_time2)) %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                           "Midlands","East of England","London","South East","South West"))) %>% 
  mutate(contact_count=as.numeric(contact_count)) %>% 
  mutate(calls_answered=as.numeric(calls_answered)) %>% 
  select(c(contact_count:calls_answered,date:org_lab))


plot<-amb_dta_plot %>%
  filter(org_lab=="England") %>%
  select(-c("metric", "answer_time", "answer_time2")) %>% 
  pivot_longer(c(contact_count, calls_answered), names_to="metric", values_to="count") %>% 
  ggplot(.,aes(x=date2, y=count, group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_line(aes(y=calls_answered),linetype='solid', colour="blue")+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))



ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```


## Counts (rolling average)  

```{r, echo=FALSE}

rolling_count_answered<-amb_dta_plot %>% 
  filter(org_lab=="England") %>% 
  dplyr::select(c(date2,date,contact_count, calls_answered)) %>% 
  distinct() %>% 
  mutate(contact_count_rollmean=rollmean(contact_count, k=12, fill=NA),
         calls_answered_rollmean=rollmean(calls_answered, k=12, fill=NA)) %>% 
  drop_na()

start_dates<-format(as.Date(seq(ymd('2017-08-01'),ymd('2021-05-01'),by='1 month')),"%Y-%m-%d")
end_dates<-format(as.Date(seq(ymd('2018-07-01'),ymd('2022-04-01'),by='1 month')),"%Y-%m-%d")

list_dates<-paste0(yearmonth(start_dates),"-",yearmonth(end_dates))
order<-c(1:46)

rolling_count_answered<-cbind(rolling_count_answered,list_dates,order)

rolling_count_answered_plot<-rolling_count_answered %>% 
  select(list_dates, order, contains("rollmean")) %>% 
  pivot_longer(contains("rollmean"), names_to="metric", values_to="val") %>% 
  mutate(name=fct_reorder(list_dates,order)) 

plot<-rolling_count_answered_plot %>% 
  ggplot(.,aes(x=name, y=val, group=metric, colour=metric))+
  geom_line(linetype='solid')+
  scale_y_continuous(labels=comma)+
  theme_THF()+
  # facet_grid(cols=vars(met_cat))+
  scale_colour_THF()+
  labs(x = "", y="counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))


ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```



## Mean call answer times 

```{r, echo=FALSE}

plot<-amb_dta_plot %>%
  filter(org_lab=="England" & metric=="answered_times_mean") %>%
  ggplot(.,aes(x=date2, y=answer_time2, group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Call answer times (seconds)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))


ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```

## Mean answer times (rolling average)

```{r, echo=FALSE}

rolling_mean_answer<-amb_dta_plot %>% 
  filter(org_lab=="England"& metric=="answered_times_mean") %>% 
  dplyr::select(c(date2,date,answer_time)) %>% 
  mutate(answer_time_rollmean=rollmean(as.numeric(answer_time), k=12, fill=NA)) %>% 
  drop_na() %>% 
  mutate(answer_time2_rollmean=as.POSIXct(as.numeric(answer_time_rollmean),origin = "1970-01-01", tz="GMT")) %>% 
  mutate(answer_time2_rollmean=format(answer_time2_rollmean, format="%H:%M:%S")) %>% 
  mutate(answer_time2_rollmean=as_hms(answer_time2_rollmean))


rolling_mean_answer<-cbind(rolling_mean_answer,list_dates,order)

plot<-rolling_mean_answer %>%
  mutate(name=fct_reorder(list_dates,order)) %>% 
  ggplot(.,aes(x=name, y=answer_time2_rollmean, group=1))+
  geom_line(linetype='solid', colour='#dd0031')+
  # scale_y_time(breaks = as_hms(seq(0, 72000, by = 1800)))+
  theme_THF()+
  scale_colour_THF()+
  labs(x = "", y="Mean answer time (seconds)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```


# Resources 

```{r, echo=FALSE}
buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'


amb_dta<-s3read_using(read.csv # Which function are we using to read
                      , object = 'amb_resources.csv' # File to open
                      , bucket = buck) # Bucket name defined above

amb_incidents<-amb_dta %>% 
  select(date, org_name,c1:c4) %>% 
  pivot_longer(c(c1:c4), names_to = 'type', values_to = 'incidents')

type<-c("c1", "c1t", "c2", "c3", "c4")

amb_alloc<-amb_dta %>% 
  select(date, org_name,paste0(type,"_alloc")) %>% 
  pivot_longer(c(c1_alloc:c4_alloc), names_to = 'type', values_to = 'alloc') %>% 
  mutate(type=ifelse(str_detect(type, "t"),substr(type, 0,3), substr(type,0,2)))

amb_arrive<-amb_dta %>% 
  select(date, org_name,paste0(type,"_arrive")) %>% 
  pivot_longer(c(c1_arrive:c4_arrive), names_to = 'type', values_to = 'arrive') %>% 
  mutate(type=ifelse(str_detect(type, "t"),substr(type, 0,3), substr(type,0,2)))


amb_dta_plot<-amb_incidents %>% 
  left_join(amb_alloc, by=c("date", "org_name", "type")) %>% 
  left_join(amb_arrive, by=c("date", "org_name", "type")) %>% 
  mutate(incidents=as.numeric(incidents),
         alloc=as.numeric(alloc),
         arrive=as.numeric(arrive)) %>% 
  mutate(mean_alloc=alloc/incidents) %>% 
  mutate(mean_arrive=arrive/incidents) %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                           "Midlands","East of England","London","South East","South West")))

plot<-amb_dta_plot %>%
  filter(org_lab=="England") %>%
  pivot_longer(c(mean_alloc, mean_arrive), names_to="metric", values_to="count") %>% 
  ggplot(.,aes(x=date2, y=count, group=type, colour=type))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(metric))+
  scale_colour_THF()+
  labs(x = "", y="Mean resources arriving on scene", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

