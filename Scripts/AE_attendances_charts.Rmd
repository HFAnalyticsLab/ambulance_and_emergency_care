---
title: "Attendances at A&E and admissions from A&E April 2018 to March 2022 "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(aws.s3)
library(tidyverse)
library(ggplot2)

```

This document is for scoping purposes and is not intended for use outside of the Data Analaytics team.\
Data obtained from NHS England A&E attenaces and emergency admissions https://www.england.nhs.uk/statistics/statistical-work-areas/ae-waiting-times-and-activity/ 

Attendances at A&E and admissions from A&E overall and by Type for each Region

```{r derive, echo=FALSE}
# Clean data 

aeattend <- readRDS("aeattend.rds")

aeattend <- aeattend %>%
  mutate(time=paste0(year, formatC(month, width=2, flag="0"))) %>%
  mutate(pct4to12hrsadmit=ifelse(totaladmit==0, 0, pct4to12hrsadmit )) %>%
  mutate(pct12plushrsadmit=ifelse(totaladmit==0, 0, pct12plushrsadmit )) 


displaysummattend <- aeattend %>%
  group_by(`NHS England Region`, year, month) %>%
  summarise(meanattend=mean(totalattend), meanadmit=mean(totaladmit), n=n()) ## why is March 2019 data missing?

summattend <- aeattend %>%
  drop_na(totalattend) %>%
  drop_na(`Number of A&E attendances Type 1`) %>%
  drop_na(`Number of A&E attendances Type 2`) %>%
  drop_na(`Number of A&E attendances Other A&E Department`) %>%
  group_by(`NHS England Region`, time) %>%
  summarise(meanattend=mean(totalattend), meanadmit=mean(totaladmit), meantype1=mean(`Number of A&E attendances Type 1`),
            meantype2=mean(`Number of A&E attendances Type 2`), meantypeoth=mean(`Number of A&E attendances Other A&E Department`), n=n())

```

## A&E attendances

Type 1 A&E department = Increasingly referred to as an Emergency Department. A consultant led 24-hour service with full resuscitation facilities and designated accommodation for the reception of accident and emergency patients.  

Type 2 A&E department = A consultant led single specialty accident and emergency service or Emergency Department (e.g. ophthalmology, dental) with designated accommodation for the reception of patients. 

Type 3 A&E department. These are now Urgent Treatment Centres (UTCs). These are GP-led, open at least 12 hours a day, every day, offer appointments that can be booked through 111 or through a GP referral, and are equipped to diagnose and deal with many of the most common ailments people attend A&E for.  

East of England had 0 Type 2 attendances throughout, with the exception of one month.

```{r plotattend, echo=FALSE}
## figure of attendances
ggplot(data=summattend, aes(x=time, y=meanattend, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("Number of A&E attendances") +
  ggtitle("Apr2018-Mar2022") + 
  theme(axis.text.x=element_text(angle=90, hjust=1))
ggplot(data=summattend, aes(x=time, y=meantype1, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("Number of type 1 attendances") +
  ggtitle("Apr2018-Mar2022") + 
  theme(axis.text.x=element_text(angle=90, hjust=1))
ggplot(data=summattend, aes(x=time, y=meantype2, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("Number of type 2 attendances") +
  ggtitle("Apr2018-Mar2022") + 
  theme(axis.text.x=element_text(angle=90, hjust=1))
ggplot(data=summattend, aes(x=time, y=meantypeoth, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("Number of other attendances") +
  ggtitle("Apr2018-Mar22") + 
  theme(axis.text.x=element_text(angle=90, hjust=1))


```


## waiting times in A&E


```{r plotwaittime, echo=FALSE}

summattend <- aeattend %>%
  drop_na(pct4plushrswaittype1) %>%
  drop_na(pct4plushrswaittype2) %>%
  group_by(`NHS England Region`, time) %>%
  summarise(mean4pluswaittype1=mean(pct4plushrswaittype1),
            mean4pluswaittype2=mean(pct4plushrswaittype2), n=n())

## figure of attendee waiting times
ggplot(data=summattend, aes(x=time, y=mean4pluswaittype1, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("% waiting 4+ hrs in A&E type 1") +
  ggtitle("Apr2018-Mar2022")

ggplot(data=summattend, aes(x=time, y=mean4pluswaittype2, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("% waiting 4+ hrs in A&E type 2") +
  ggtitle("Apr2018-Mar2022") + 
  theme(axis.text.x=element_text(angle=90, hjust=1))


```


## Admissions from A&E


```{r plotadmit, echo=FALSE}

summattend <- aeattend %>%
  drop_na(totaladmit) %>%
  drop_na(pct4to12hrsadmit) %>%
  drop_na(pct12plushrsadmit) %>%
  group_by(`NHS England Region`, time) %>%
  summarise(meanadmit=mean(totaladmit), mean412admit=mean(pct4to12hrsadmit), mean12plusadmit=mean(pct12plushrsadmit), n=n())

## figure of admissions from A&E
ggplot(data=summattend, aes(x=time, y=meanadmit, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("Number admitted from A&E") +
  ggtitle("Apr2018-Mar2022") + 
  theme(axis.text.x=element_text(angle=90, hjust=1))

ggplot(data=summattend, aes(x=time, y=mean412admit, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("% waiting 4-12 hrs to be admitted from A&E") +
  ggtitle("Apr2018-Mar2022") + 
  theme(axis.text.x=element_text(angle=90, hjust=1))

ggplot(data=summattend, aes(x=time, y=mean12plusadmit, group=`NHS England Region`)) +
  geom_line(aes(linetype=`NHS England Region`, colour=`NHS England Region`)) +
  ylab("% waiting 12+ hrs to be admitted from A&E") +
  ggtitle("Apr2018-Mar2022") + 
  theme(axis.text.x=element_text(angle=90, hjust=1)) + 
  ylim(0,20)


```

## All England
All England


```{r plotEngland, echo=FALSE}
summattend <- aeattend %>%
  drop_na(totalattend) %>%
  drop_na(`Number of A&E attendances Type 1`) %>%
  group_by(time) %>%
  summarise(meanattend=mean(totalattend), meantype1=mean(`Number of A&E attendances Type 1`),
            meantype2=mean(`Number of A&E attendances Type 2`), meantypeoth=mean(`Number of A&E attendances Other A&E Department`), n=n())

ggplot() +
  geom_line(mapping=aes(x=summattend$time, y=summattend$meanattend), color="blue", group=1) +
  geom_line(mapping=aes(x=summattend$time, y=summattend$meantype1), color="red", group=1) +
  ggtitle("Apr2018-Mar21") + 
  ylab("Number of attendances") +
  xlab("month and year") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  ggtitle("blue = All A&E types, red=Type 1") 
  
summattend <- aeattend %>%
  drop_na(pct4plushrswaittype1) %>%
  drop_na(pct4plushrswaittype2) %>%
  group_by(time) %>%
  summarise(mean4pluswaittype1=mean(pct4plushrswaittype1),
            mean4pluswaittype2=mean(pct4plushrswaittype2), n=n())

ggplot() +
  geom_line(mapping=aes(x=summattend$time, y=summattend$mean4pluswaittype1), color="red", group=1) +
  geom_line(mapping=aes(x=summattend$time, y=summattend$mean4pluswaittype2), color="black", group=1) +
  ggtitle("Apr2018-Mar21") + 
  ylab("% waiting 4+ hours in A&E") +
  xlab("month and year") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  ggtitle("red = type 1, black=Type 2") 


summattend <- aeattend %>%
  drop_na(totaladmit) %>%
  drop_na(pct4to12hrsadmit) %>%
  drop_na(pct12plushrsadmit) %>%
  group_by(time) %>%
  summarise(meanadmit=mean(totaladmit), mean412admit=mean(pct4to12hrsadmit), mean12plusadmit=mean(pct12plushrsadmit), n=n())

ggplot() +
  geom_line(mapping=aes(x=summattend$time, y=summattend$meanadmit), color="blue", group=1) +
  ggtitle("Apr2018-Mar21") + 
  ylab("Number admitted from A&E") +
  xlab("month and year") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) + 
  ggtitle("Apr2018-Mar2022")

ggplot() +
  geom_line(mapping=aes(x=summattend$time, y=summattend$mean412admit), color="red", group=1) +
  geom_line(mapping=aes(x=summattend$time, y=summattend$mean12plusadmit), color="black", group=1) +
  ggtitle("Apr2018-Mar21") + 
  ylab("% delayed in being admitted from A&E") +
  xlab("month and year") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  ggtitle("red = % waiting 4-12 hrs, black=% waiting 12+ hrs") 


```
