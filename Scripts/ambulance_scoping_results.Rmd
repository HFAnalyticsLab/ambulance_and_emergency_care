---
title: "Ambulance Quality Indicators"
output:
   html_document:
    toc: true
    toc_float: true
    theme: paper
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(data.table)
library(aws.s3)
library(readr)
library(tidyverse)
library(rio)
library(lubridate)
library(ggplot2)
library(ggtext)
library(hms)
library(tidyverse)
library(THFstyle)
library(plotly)
library(tsibble)

```


This document is for scoping purposes and is not intended for use outside of the Data Analaytics team.\
Data obtained from [NHS England, Ambulance Quality Indicators](https://www.england.NHS.uk/statistics/statistical-work-areas/ambulance-quality-indicators/ambulance-quality-indicators-data-2021-22/)\

# Ambulance Reponse Times 

## By Region for each Cateogory {.tabset}

Response times by regions and category of incidents. There are 7 regions:

* North East and Yorkshire
* North West
* Midlands
* East of England
* London
* South East
* South West 

```{r load, echo=FALSE}
buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'


amb_dta<-s3read_using(read.csv # Which function are we using to read
                   , object = 'amb_RT_clean.csv' # File to open
                   , bucket = buck) # Bucket name defined above

amb_dta_plot<-amb_dta %>% 
 pivot_longer(c(c1_mean:c4_90thcent), names_to = 'metric', values_to = 'resp_time')

amb_dta_plot<-amb_dta_plot %>% 
  mutate(resp_time2=as.POSIXct(as.numeric(resp_time),origin = "1970-01-01", tz="GMT")) %>% 
  mutate(resp_time2=format(resp_time2, format="%H:%M:%S")) %>% 
  mutate(resp_time2=as_hms(resp_time2)) %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                              "Midlands","East of England","London","South East","South West")))


m <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 0
)



```

### C1: Life threatening 
**Overview**:

* A time critical life threatening event requiring immediate intervention or resuscitation
* Average response time target: 7 mins
* 90th percentile response target: 15 mins


```{r C1, echo=FALSE}

c1<-amb_dta_plot %>%
  filter(str_detect(metric, 'c1_')) %>%
  mutate(met_lab=ifelse(metric=="c1_mean", "Mean (min:sec)", "90th centile (min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6.5))


ggplotly(c1) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```

**Summary**:

* Historically, London has been consistently or nearly reached both the targets apart from the start of the COVID-19 pandemic (March-April 2020)
* Recent increases in response times for East of England and South West around June 2021 onwards
* Other than the deviations between London, East of England and South West, similar performance across regions 

### C1T 

**Overview**:

* Life threatening incidents (C1) that required transportation from the ambulance service emergency vehicle
* Target times for these types of incidents are not clear (will investigate more)

```{r C1T, echo=FALSE}

c1T<-amb_dta_plot %>%
  filter(str_detect(metric, 'c1T_')) %>%
  mutate(met_lab=ifelse(metric=="c1T_mean", "Mean (min:sec)", "90th centile (min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6.5))

ggplotly(c1T) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```

**Summary**:

* Historically, transfers in Midland seems to fair worse than the rest of the country
* Similar performance across the regions



### C2: Emergency Calls

**Overview**:

* Potentially serious conditions that may require rapid assessment and urgent on-scene intervention and/or urgent transport.
* Average response times target: 18 minutes
* 90th percentile response target: 40 minutes

```{r C2, echo=FALSE}

c2<-amb_dta_plot %>%
  filter(str_detect(metric, 'c2_')) %>%
  mutate(met_lab=ifelse(metric=="c2_mean", "Mean (hours:min:sec)", "90th centile (hours:min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  geom_hline(yintercept = as_hms("00:18:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("00:40:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6.5))

ggplotly(c2) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

**Summary:**

* Upward trend in response times across regions from the start of 2021 ownwards
* Recently, South West and East of England regions are registering higher than average response times compared to their previous trend and compared to the England average 


### C3: Urgent calls
**Overview:** 

* An urgent problem (not immediately life threatening) that needs treatment to relieve suffering and transport or assessment and management at the scene with referral where needed within a clinically appropriate timeframe.
* Average response times target: None (mean indicator of 60 minutes)
* 90th percentile response target: 2 hours 

```{r C3, echo=FALSE}
c3<-amb_dta_plot %>%
  filter(str_detect(metric, 'c3_')) %>%
  mutate(met_lab=ifelse(metric=="c3_mean", "Mean (hours:min:sec)", "90th centile (hours:min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  geom_hline(yintercept = as_hms("01:00:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("02:00:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6.5))

ggplotly(c3) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

**Summary:**

* Upward trends across regions, similar to C2 calls. 
* In recent times, South West, East of England and North west are registering higher response times compared to other regions, and past trends. 

### C4: Less urgent calls

**Overview:**

* Problems that are less urgent but require assessment and possibly transport within a clinically appropriate timeframe.
* Average response times target: None
* 90th percentile response target: 3 hours 

```{r C4, echo=FALSE}
c4<-amb_dta_plot %>%
  filter(str_detect(metric, 'c4_')) %>%
  mutate(met_lab=ifelse(metric=="c4_mean", "Mean (hours:min:sec)", "90th centile (hours:min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("03:00:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6.5))

ggplotly(c4) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)
```

**Summary:**

* Again upward trend in recent months, particularly in North West, East of England and South West  


### Notes
* Across the different categories, you can see the knock on effect of categories 1 and 2 categories- those reporting longer responses times for these categories tend to report even longer response times for category 3 and 4. 
* There were some regions reaching the target response times for category 2-4 but there is a clear upward trend across the service which means that almost all regions were missing targets in recent months 

## By Category for each Region {.tabset}

```{r setup_regions, echo=FALSE}

org_list<-unique(amb_dta_plot$org_name)

```


```{r graphs_function, echo=FALSE}

trends_graph <-  function(data=amb_dta_plot,var.x="North East and Yorkshire"){
  aaa <- ggplot2::enquo(var.x)
  # bbb <- ggplot2::enquo(var.y)
  plot <-  data %>%
    filter(org_lab==!!aaa) %>%
      mutate(met_group=substr(metric,0,3)) %>% 
  mutate(met_cat=ifelse(str_detect(metric,'mean'),'Mean','90th centile')) %>% 
  mutate(met_cat=factor(met_cat, levels=c('Mean', '90th centile'))) %>% 
  mutate(met_lab=ifelse(str_detect(metric, 'mean'), paste(met_group,"_Mean (hours:min:sec)")
                        ,paste(met_group,"_90th centile (hours:min:sec)"))) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_group, colour=met_group))+
  geom_line(aes(linetype=met_cat))+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(met_cat))+
  scale_colour_THF()+
    labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
    ggtitle(var.x)+
    theme(legend.text=element_text(size=11),
          legend.title = element_blank(),
          axis.text.x=element_text(size=8, angle=60), 
          axis.text.y=element_text(size=11),
          plot.caption = element_markdown(hjust=0, size=9),
          plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(-10,-10,-10,-10))

  ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)
}


```


### England

```{r}
trends_graph(var.x=org_list[1])

```

### North East and Yorkshire

```{r}
trends_graph(var.x=org_list[2])

```

### North West

```{r}
trends_graph(var.x=org_list[3])

```

### Midlands 

```{r}
trends_graph(var.x=org_list[4])

```

### East of England
```{r}
trends_graph(var.x=org_list[5])

```

### London
```{r}
trends_graph(var.x=org_list[6])

```

### South East
```{r}
trends_graph(var.x=org_list[7])

```

### South West
```{r}
trends_graph(var.x=org_list[8])

```

## By Trust for each Category {.tabset}

Response times by Trusts and category of incidents. There are 11 NHS trusts: 

* East Midlands Ambulance Service NHS Trust
* East of England Ambulance Service NHS Trust
* Isle of Wight NHS Trust
* London Ambulance Service NHS Trust
* North East Ambulance Service NHS Foundation Trust
* North West Ambuance Service NHS Trust
* South Central Ambulance Service NHS Foundation Trust
* South East Coast Ambulance Service NHS Foundation Trust
* South Western Ambulance Service NHS Foundation Trust
* West Midlands Ambulance Service University NHS Foundation Trust 
* Yorkshire Ambulance Service NHS Trust. 


```{r load_trusts, echo=FALSE}
buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'


amb_dta_trusts<-s3read_using(read.csv # Which function are we using to read
                      , object = 'amb_RT_trusts.csv' # File to open
                      , bucket = buck) # Bucket name defined above


amb_dta_plot<-amb_dta_trusts %>% 
  pivot_longer(c(c1_mean:c4_90thcent), names_to = 'metric', values_to = 'resp_time') %>% 
  filter(org_name != "WEST MIDLANDS AMBULANCE SERVICE NHS FOUNDATION TRUST")


long_names<-c("England", "EAST MIDLANDS AMBULANCE SERVICE NHS TRUST", "EAST OF ENGLAND AMBULANCE SERVICE NHS TRUST" ,"ISLE OF WIGHT NHS TRUST",                                        
              "LONDON AMBULANCE SERVICE NHS TRUST", "NORTH EAST AMBULANCE SERVICE NHS FOUNDATION TRUST", "NORTH WEST AMBULANCE SERVICE NHS TRUST",                         
              "SOUTH CENTRAL AMBULANCE SERVICE NHS FOUNDATION TRUST", "SOUTH EAST COAST AMBULANCE SERVICE NHS FOUNDATION TRUST", "SOUTH WESTERN AMBULANCE SERVICE NHS FOUNDATION TRUST",
              "WEST MIDLANDS AMBULANCE SERVICE UNIVERSITY NHS FOUNDATION TRUST", "YORKSHIRE AMBULANCE SERVICE NHS TRUST") 


label_names<-c("England", "East Midlands", "East of England" ,"Isle of Wight",                                        
               "London", "North East", "North West",                         
               "South Central", "South East Coast", "South Western",
               "West Midlands", "Yorkshire") 


amb_dta_plot<-amb_dta_plot %>% 
  mutate(resp_time2=as.POSIXct(as.numeric(resp_time),origin = "1970-01-01", tz="GMT")) %>% 
  mutate(resp_time2=format(resp_time2, format="%H:%M:%S")) %>% 
  mutate(resp_time2=as_hms(resp_time2)) %>% 
  mutate(date2=yearmonth(date)) %>%
  mutate(org_lab=factor(org_name, levels=long_names, labels=label_names))

m <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 0
)



```

### C1: Life threatening 
**Overview**:

* A time critical life threatening event requiring immediate intervention or resuscitation
* Average response time target: 7 mins
* 90th percentile response target: 15 mins


```{r C1_trusts, echo=FALSE}

c1<-amb_dta_plot %>%
  filter(str_detect(metric, 'c1_')) %>%
  mutate(met_lab=ifelse(metric=="c1_mean", "Mean (min:sec)", "90th centile (min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=6, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))


ggplotly(c1) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```

**Summary**:

* London and North East are more or less reaching the targets. 
* Historically, South Central and West Midlands were also reaching the targets until recent months.
* Isle of Wight have not reached the targets (except on Feb 2021, they reached the 90th percentile target)
* Clear increases in response times in the East of England, South Central and South Western 

### C1T 

**Overview**:

* Life threatening incidents (C1) that required transportation from the ambulance service emergency vehicle
* Target times for these types of incidents are not clear (will investigate more)

```{r C1T_trusts, echo=FALSE}

c1T<-amb_dta_plot %>%
  filter(str_detect(metric, 'c1T_')) %>%
  mutate(met_lab=ifelse(metric=="c1T_mean", "Mean (min:sec)", "90th centile (min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  # geom_hline(yintercept = as_hms("00:15:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=6, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))

ggplotly(c1T) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```

**Summary**:

* For C1 incidents requiring ambulance transportation, East Midlands are doing worse than the national average for both targets. 


### C2: Emergency Calls

**Overview**:

* Potentially serious conditions that may require rapid assessment and urgent on-scene intervention and/or urgent transport.
* Average response times target: 18 minutes
* 90th percentile response target: 40 minutes

```{r C2_trusts, echo=FALSE}

c2<-amb_dta_plot %>%
  filter(str_detect(metric, 'c2_')) %>%
  mutate(met_lab=ifelse(metric=="c2_mean", "Mean (hours:min:sec)", "90th centile (hours:min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  geom_hline(yintercept = as_hms("00:18:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("00:40:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=6, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))

ggplotly(c2) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

**Summary:**

* Upward trend over time across all trusts, especially in recent months (apart from Isle of Wight). So even the trusts that were meeting the target times previously are no longer meeting them 
* South Western is reporting the highest response times in recent months followed by East of England. 

### C3: Urgent calls
**Overview:** 

* An urgent problem (not immediately life threatening) that needs treatment to relieve suffering and transport or assessment and management at the scene with referral where needed within a clinically appropriate timeframe.
* Average response times target: None (mean indicator of 60 minutes)
* 90th percentile response target: 2 hours 

```{r C3_trusts, echo=FALSE}
c3<-amb_dta_plot %>%
  filter(str_detect(metric, 'c3_')) %>%
  mutate(met_lab=ifelse(metric=="c3_mean", "Mean (hours:min:sec)", "90th centile (hours:min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  geom_hline(yintercept = as_hms("01:00:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("02:00:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=6, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))

ggplotly(c3) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

**Summary:**

* Again clear upward trend across trusts in recent months (apart from Isle of Wight), even trusts that were performing well before are no longer meeting the targets
* South Western is reporting the longest response times (both average and 90th percentile), followed by East of England 



### C4: Less urgent calls

**Overview:**

* Problems that are less urgent but require assessment and possibly transport within a clinically appropriate time frame.
* Average response times target: None
* 90th percentile response target: 3 hours 

```{r C4_trusts, echo=FALSE}
c4<-amb_dta_plot %>%
  filter(str_detect(metric, 'c4_')) %>%
  mutate(met_lab=ifelse(metric=="c4_mean", "Mean (hours:min:sec)", "90th centile (hours:min:sec)")) %>% 
  ggplot(.,aes(x=date2, y=resp_time2, group=met_lab, colour=met_lab))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_hline(yintercept = as_hms("00:07:00"), colour = '#524c48', linetype='dashed' )+
  geom_hline(yintercept = as_hms("03:00:00"), colour = '#524c48', linetype='dashed')+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Response time (minutes)", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=6, angle=90), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))

ggplotly(c4) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)
```

**Summary:**

* Upward trend in recent months but North West and South Western are reporting the longest response times
* West Midlands was reporting below the target until recent months 
* North East and Isle of Wight did not not experience the uptick in response times in recent months 


### Notes

* Clear upward tick across all incidents for most of the trusts so suggesting that there may be something else going on (definitely should explore further)
* It's interesting that the Isle of Wight is not performing as badly on C2, C3 and C4 incidents than they are on C1 incidents. So knock on effects are less clear here 
* But we are still seeing some trusts performing well on C1 targets but not necessarily the best performers on C2-C4 targets
* South Western is reporting the longest response times across all incidents and worth exploring furher what is going on 


## By Category for each Trust {.tabset}


### England
```{r, echo=FALSE}
trends_graph(var.x=label_names[1])
```


### East Midlands
```{r, echo=FALSE}
trends_graph(var.x=label_names[2])
```


### East of England
```{r, echo=FALSE}
trends_graph(var.x=label_names[3])
```

### Isle of Wight
```{r, echo=FALSE}
trends_graph(var.x=label_names[4])
```

### London
```{r, echo=FALSE}
trends_graph(var.x=label_names[5])
```

### North East
```{r, echo=FALSE}
trends_graph(var.x=label_names[6])
```


### North West
```{r, echol=FALSE}
trends_graph(var.x=label_names[7])
```


### South Central
```{r, echo=FALSE}
trends_graph(var.x=label_names[8])
```


### South East Coast
```{r, echo=FALSE}
trends_graph(var.x=label_names[9])
```


### South Western
```{r, echo=FALSE}
trends_graph(var.x=label_names[10])
```


### West Midlands
```{r, echo=FALSE}
trends_graph(var.x=label_names[11])
```



### Yorkshire

```{r, echo=FALSE}
trends_graph(var.x=label_names[12])
```

# Incidents

```{r, echo=FALSE}

buck<-'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/ambulance/clean'

amb_incidents<-s3read_using(read.csv # Which function are we using to read
                      , object = 'amb_incidents.csv' # File to open
                      , bucket = buck) # Bucket name defined above

list_org_codes_region<-c("Y63", "Y62","Y60", "Y61", "Y56", "Y59", "Y58")



amb_dta_regions<-amb_incidents %>% 
  filter(org_code %in% c(list_org_codes_region, "Eng")) %>%
  select(c(year:c4, date)) %>% 
  pivot_longer(c(all_incidents:c4), names_to = 'metric', values_to = 'incidents')


amb_dta_regions<-amb_dta_regions %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                           "Midlands","East of England","London","South East","South West")))



list_org_codes_trust<-c("RX9", "RYC", "R1F", "RRU", "RX6", "RX7", "RYE", "RYD", "RYF", "RYA", "RX8") 

amb_dta_incidents_trust<-amb_incidents %>% 
  filter(org_code %in% c(list_org_codes_trust, "Eng")) %>% 
  select(c(year:c4, date)) %>% 
  pivot_longer(c(all_incidents:c4), names_to = 'metric', values_to = 'incidents')

amb_dta_incidents_trust<-amb_dta_incidents_trust %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(incidents=as.numeric(incidents)) %>% 
  filter(org_name != "WEST MIDLANDS AMBULANCE SERVICE NHS FOUNDATION TRUST")


long_names<-c("England", "EAST MIDLANDS AMBULANCE SERVICE NHS TRUST", "EAST OF ENGLAND AMBULANCE SERVICE NHS TRUST" ,"ISLE OF WIGHT NHS TRUST",                                        
              "LONDON AMBULANCE SERVICE NHS TRUST", "NORTH EAST AMBULANCE SERVICE NHS FOUNDATION TRUST", "NORTH WEST AMBULANCE SERVICE NHS TRUST",                         
              "SOUTH CENTRAL AMBULANCE SERVICE NHS FOUNDATION TRUST", "SOUTH EAST COAST AMBULANCE SERVICE NHS FOUNDATION TRUST", "SOUTH WESTERN AMBULANCE SERVICE NHS FOUNDATION TRUST",
              "WEST MIDLANDS AMBULANCE SERVICE UNIVERSITY NHS FOUNDATION TRUST", "YORKSHIRE AMBULANCE SERVICE NHS TRUST") 


label_names<-c("England", "East Midlands", "East of England" ,"Isle of Wight",                                        
               "London", "North East", "North West",                         
               "South Central", "South East Coast", "South Western",
               "West Midlands", "Yorkshire") 

amb_dta_incidents_trust<-amb_dta_incidents_trust %>% 
  mutate(org_lab=factor(org_name, levels=long_names, labels=label_names)) 






```



## All incidents  {.tabset}

### England 

```{r, echo=FALSE}



plot<-amb_dta_regions %>%
  filter(org_code=="Eng"& metric=="all_incidents")%>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = 'months',date_labels = "%b %g")+
  # scale_y_continuous(labels = comma) +
  theme_THF()+
  # facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)



```

### Regions 
```{r, echo=FALSE}

plot<-amb_dta_regions %>%
  filter(org_code != "Eng" & metric == "all_incidents") %>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```

### Trusts

```{r, echo=FALSE}

plot<-amb_dta_incidents_trust %>%
  filter(org_code != "Eng" & metric == "all_incidents") %>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```


## Category  {.tabset}

### England 


```{r, echo=FALSE}

plot<-amb_dta_regions %>%
  filter(org_code == "Eng"& metric != "all_incidents" ) %>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = 'months',date_labels = "%b %g")+
  theme_THF()+
  # facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```


### Regions


```{r, echo=FALSE}

plot<-amb_dta_regions %>%
  filter(org_code != "Eng" & metric != "all_incidents") %>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```

### Trusts

```{r, echo=FALSE}

plot<-amb_dta_incidents_trust %>%
  filter(org_code != "Eng" & metric != "all_incidents") %>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = '6 months',date_labels = "%b %g")+
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Counts", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)


```

## Outcomes {.tabset}

```{r, echo=FALSE}

amb_dta_regions_out<-amb_incidents %>% 
  filter(org_code %in% c(list_org_codes_region, "Eng")) %>% 
  select(c(year:all_incidents,hear_treat:date)) %>% 
  pivot_longer(c(all_incidents:see_treat), names_to = 'metric', values_to = 'incidents')

amb_dta_regions_out<-amb_dta_regions_out %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(incidents=as.numeric(incidents)) %>% 
  mutate(org_lab=factor(org_name, levels=c("England","North East and Yorkshire","North West",
                                           "Midlands","East of England","London","South East","South West")))

amb_dta_trusts_out<-amb_incidents %>% 
  filter(org_code %in% c(list_org_codes_trust, "Eng")) %>% 
  select(c(year:all_incidents,hear_treat:date)) %>% 
  pivot_longer(c(all_incidents:see_treat), names_to = 'metric', values_to = 'incidents')

amb_dta_trusts_out<-amb_dta_trusts_out %>% 
  mutate(date2=yearmonth(date)) %>% 
  mutate(incidents=as.numeric(incidents)) %>% 
  filter(org_name != "WEST MIDLANDS AMBULANCE SERVICE NHS FOUNDATION TRUST") %>% 
  mutate(org_lab=factor(org_name, levels=long_names, labels=label_names)) 


```

### England

```{r, echo=FALSE}
plot<-amb_dta_regions_out %>%
  filter(org_code=="Eng"& metric!="all_incidents")%>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = 'months',date_labels = "%b %g")+
  # scale_y_continuous(labels = comma) +
  theme_THF()+
  # facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Incidents", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)
```

### Regions


```{r, echo=FALSE}

plot<-amb_dta_regions_out %>%
  filter(org_code!="Eng"& metric!="all_incidents")%>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = 'months',date_labels = "%b %g")+
  # scale_y_continuous(labels = comma) +
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Incidents", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10))

ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)

```
 


### Trusts

```{r, echo=FALSE}

plot<-amb_dta_trusts_out %>%
  filter(org_code!="Eng"& metric!="all_incidents")%>% 
  ggplot(.,aes(x=date2, y=as.numeric(incidents), group=metric, colour=metric))+
  geom_line(linetype='solid')+
  # geom_point(size=0.25)+
  # geom_bar(aes(fill=metric),position="stack", stat="identity")+
  scale_x_yearmonth( breaks = 'months',date_labels = "%b %g")+
  # scale_y_continuous(labels = comma) +
  theme_THF()+
  facet_grid(cols=vars(org_lab))+
  scale_colour_THF()+
  labs(x = "", y="Incidents", caption = "NHS England, Ambulance Quality Indicators")+
  theme(legend.text=element_text(size=11),
        legend.title = element_blank(),
        axis.text.x=element_text(size=8, angle=60), 
        axis.text.y=element_text(size=11),
        plot.caption = element_markdown(hjust=0, size=9),
        plot.margin = unit(c(1,1.5,0.5,0.5), "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        strip.text.x = element_text(size = 6))


ggplotly(plot) %>% 
  layout(legend = list(orientation = 'v',valign="top", font=list(size=8))) %>% 
  layout(legend=list(title=list(text=''))) %>% 
  layout(autosize = F, width = 1200, height = 500, margin = m)




```

